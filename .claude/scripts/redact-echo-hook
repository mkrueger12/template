#!/usr/bin/env bash
#
# redact-echo-hook - PreToolUse hook to redact sensitive env var values in echo commands
#
# Reads tool input JSON from stdin, redacts any env var values found in echo commands,
# and outputs modified JSON to replace the command.

set -euo pipefail

VISIBLE_CHARS=6

# List of env var names to redact (add more as needed)
SENSITIVE_VARS=(
  "MY_API_KEY"
  "API_KEY"
  "SECRET"
  "PASSWORD"
  "TOKEN"
  "ANTHROPIC_API_KEY"
  "OPENAI_API_KEY"
)

redact() {
  local value="$1"
  local len="${#value}"

  if [[ $len -le $((VISIBLE_CHARS + 3)) ]]; then
    printf '%s' "${value//?/*}"
  else
    printf '%s%s' "${value:0:$VISIBLE_CHARS}" "$(printf '%*s' $((len - VISIBLE_CHARS)) '' | tr ' ' '*')"
  fi
}

# Read JSON from stdin
input=$(cat)

# Extract the command
command=$(echo "$input" | jq -r '.tool_input.command // empty')

# Exit if not an echo command
if [[ ! "$command" =~ ^echo[[:space:]] ]]; then
  exit 0
fi

modified_command="$command"

# Check each sensitive var and redact its value if found in command
for var_name in "${SENSITIVE_VARS[@]}"; do
  if [[ -n "${!var_name+x}" ]] && [[ -n "${!var_name}" ]]; then
    value="${!var_name}"
    if [[ "$modified_command" == *"$value"* ]]; then
      redacted=$(redact "$value")
      modified_command="${modified_command//$value/$redacted}"
    fi
  fi
done

# If command was modified, output JSON to update it
if [[ "$modified_command" != "$command" ]]; then
  jq -n --arg cmd "$modified_command" '{
    "decision": "modify",
    "tool_input": {"command": $cmd}
  }'
else
  exit 0
fi
