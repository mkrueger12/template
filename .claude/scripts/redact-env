#!/usr/bin/env bash
#
# redact-env - Echo an environment variable with sensitive info partially redacted
#
# Usage: redact-env ENV_VAR_NAME

set -euo pipefail

VISIBLE_CHARS=6

usage() {
  echo "Usage: $(basename "$0") ENV_VAR_NAME"
  exit 1
}

redact() {
  local value="$1"
  local len="${#value}"

  if [[ $len -le $((VISIBLE_CHARS + 3)) ]]; then
    # Too short to redact meaningfully, mask entirely
    printf '%s\n' "${value//?/*}"
  else
    # Show first N chars, then redact the rest
    printf '%s%s\n' "${value:0:$VISIBLE_CHARS}" "$(printf '%*s' $((len - VISIBLE_CHARS)) '' | tr ' ' '*')"
  fi
}

[[ $# -lt 1 ]] && usage

var_name="$1"

if [[ -z "${!var_name+x}" ]]; then
  echo "Error: Environment variable '$var_name' is not set" >&2
  exit 1
fi

value="${!var_name}"

if [[ -z "$value" ]]; then
  echo "$var_name=(empty)"
else
  echo "$var_name=$(redact "$value")"
fi
